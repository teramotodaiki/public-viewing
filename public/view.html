<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/6.3.3/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <!-- <script defer src="/__/firebase/6.3.3/firebase-auth.js"></script> -->
    <script defer src="/__/firebase/6.3.3/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <style>
      body {
        background-color: black;
        color: white;
      }
    </style>
  </head>
  <body>
    <script>
      // config
      let speed = 2; // コメントの流れる速度 [px/frame]
      let concurrency = 1; // 同時に subscribe できるコメント数. もしもチャットが詰まってきたら増やす

      document.addEventListener("DOMContentLoaded", function() {
        const elements = [];

        firebase
          .firestore()
          .collection("chats")
          .orderBy("created", "desc")
          .limit(concurrency)
          .onSnapshot(snapshot => {
            for (let item of snapshot.docChanges()) {
              if (item.type === "added") {
                const data = item.doc.data();
                const h1 = document.createElement("h1");
                h1.textContent = data.text;
                const rect = h1.getBoundingClientRect();
                h1.style.position = "absolute";
                h1.style.right = `${-rect.width}px`;
                document.body.appendChild(h1);
                elements.push(h1);
              }
            }
          });

        doChatAnimation();

        function doChatAnimation() {
          // TODO: 文字が重なったら下にズラす
          for (const element of elements) {
            let right = parseInt(getComputedStyle(element).right, 10);
            right += speed;
            element.style.right = `${right}px`;
            if (element.getBoundingClientRect().right < 0) {
              element.parentNode.removeChild(element);
            }
          }
          requestAnimationFrame(doChatAnimation);
        }
      });
    </script>
  </body>
</html>
